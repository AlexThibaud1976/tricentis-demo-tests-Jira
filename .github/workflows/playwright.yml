name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      issueKey:
        description: "Jira Test Plan Key"
        required: true
      summary:
        description: "Jira issue summary"
        required: false
      os:
        description: "Système d'exploitation"
        required: true
        type: choice
        options:
          - Windows
          - Mac
      osVersion:
        description: "Version OS (ex: 11, Monterey, Sonoma)"
        required: true
        type: string
        default: "11"
      browser:
        description: "Navigateur"
        required: true
        type: choice
        options:
          - chrome
          - chromium
          - firefox
          - safari
          - edge
      browserVersion:
        description: "Version navigateur (ex: latest, 131, 18)"
        required: true
        type: string
        default: "latest"
      testScope:
        description: "Périmètre de test"
        required: true
        type: choice
        options:
          # 🎯 Tests généraux
          - all
          - sanity
          
          # 👤 Gestion de compte
          - account-creation
          - login-logout
          - account-management
          
          # 📦 Catalogue et navigation
          - catalog-navigation
          - product-search
          - product-filtering
          - manufacturer-filter
          - new-products
          
          # 🛍️ Produits
          - configurable-products
          - product-comparison
          - product-reviews
          - product-tags
          - recently-viewed
          - email-friend
          
          # 🛒 Panier et commandes
          - cart-management
          - cart-updates
          - order-checkout
          - order-history
          - guest-checkout
          
          # ⭐ Liste de souhaits
          - wishlist-management
          
          # 📧 Communication
          - newsletter-subscription
          - contact-form
          
          # 🌐 Communauté et contenu
          - community-poll
          - news-blog
          - footer-links

env:
  XRAY_ENDPOINT: xray.cloud.getxray.app
  JIRA_PROJECT_KEY: DEMO

jobs:
  # ============================================================================
  # 🌐 BROWSERSTACK - Exécution dynamique avec paramètres personnalisés
  # ============================================================================
  test-browserstack-dynamic:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 90
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Valider et résoudre la configuration BrowserStack
      shell: bash
      run: |
        node scripts/resolve-browserstack-config.js \
          --os "${{ github.event.inputs.os }}" \
          --osVersion "${{ github.event.inputs.osVersion }}" \
          --browser "${{ github.event.inputs.browser }}" \
          --browserVersion "${{ github.event.inputs.browserVersion }}"

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright (chromium driver)
      run: npx playwright install chromium

    - name: Determine test pattern
      id: test-pattern
      shell: bash
      run: |
        SCOPE="${{ github.event.inputs.testScope }}"
        case "$SCOPE" in
          "all")
            echo "pattern=tests/" >> $GITHUB_OUTPUT
            echo "description=All Tests" >> $GITHUB_OUTPUT
            ;;
          "sanity")
            echo "pattern=tests/99-sanity.spec.js" >> $GITHUB_OUTPUT
            echo "description=Sanity Tests" >> $GITHUB_OUTPUT
            ;;
          "account-creation")
            echo "pattern=tests/01-account-creation.spec.js" >> $GITHUB_OUTPUT
            echo "description=Account Creation Tests" >> $GITHUB_OUTPUT
            ;;
          "login-logout")
            echo "pattern=tests/02-login-logout.spec.js" >> $GITHUB_OUTPUT
            echo "description=Login/Logout Tests" >> $GITHUB_OUTPUT
            ;;
          "catalog-navigation")
            echo "pattern=tests/03-catalog-navigation.spec.js" >> $GITHUB_OUTPUT
            echo "description=Catalog Navigation Tests" >> $GITHUB_OUTPUT
            ;;
          "cart-management")
            echo "pattern=tests/04-cart-management.spec.js" >> $GITHUB_OUTPUT
            echo "description=Cart Management Tests" >> $GITHUB_OUTPUT
            ;;
          "order-checkout")
            echo "pattern=tests/05-order-checkout.spec.js" >> $GITHUB_OUTPUT
            echo "description=Order Checkout Tests" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "pattern=tests/" >> $GITHUB_OUTPUT
            echo "description=All Tests" >> $GITHUB_OUTPUT
            ;;
        esac

    - name: Run tests on BrowserStack
      id: run-tests
      run: npx playwright test ${{ steps.test-pattern.outputs.pattern }} --config=playwright.config.browserstack.js
      env:
        BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
        BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        BROWSERSTACK_BUILD_NAME: "GitHub Actions #${{ github.run_number }} - ${{ github.ref_name }} - ${{ env.DEVICE_NAME }} - ${{ steps.test-pattern.outputs.description }}"
        BS_WORKERS: "5"
        CI: true
      continue-on-error: true

    - name: Fetch BrowserStack build link
      if: always()
      id: bs-link
      shell: bash
      env:
        BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
        BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        BROWSERSTACK_BUILD_NAME: "GitHub Actions #${{ github.run_number }} - ${{ github.ref_name }} - ${{ env.DEVICE_NAME }} - ${{ steps.test-pattern.outputs.description }}"
      run: |
        node scripts/get-browserstack-build-link.js

    - name: Add timestamps to Xray report
      if: always()
      run: node scripts/add-timestamps-to-xray-report.js xray-report.xml

    - name: Upload BrowserStack test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: browserstack-report-${{ env.DEVICE_NAME }}
        path: |
          playwright-report/
          results.xml
          tention-days: 30

    - name: Upload results to Xray
      if: always()
      id: xray-upload
      shell: pwsh
      env:
        XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
        XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        JIRA_USER: ${{ secrets.JIRA_USER }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_URL: ${{ secrets.JIRA_URL }}
      run: |
        ./scripts/upload-xray.ps1 -IssueKey "${{ github.event.inputs.issueKey }}"

    - name: Determine test result from XML report
      if: always()
      id: test-result
      shell: bash
      run: |
        # Read failures from the XML report (more reliable than step outcome)
        if [ -f "xray-report.xml" ]; then
          FAILURES=$(grep -oP 'failures="\K[0-9]+' xray-report.xml | head -1)
          ERRORS=$(grep -oP 'errors="\K[0-9]+' xray-report.xml | head -1)
          if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
            echo "result=PASS" >> $GITHUB_OUTPUT
            echo "✅ All tests passed (0 failures, 0 errors)"
          else
            echo "result=FAIL" >> $GITHUB_OUTPUT
            echo "❌ Tests failed ($FAILURES failures, $ERRORS errors)"
          fi
        else
          echo "result=UNKNOWN" >> $GITHUB_OUTPUT
          echo "⚠️ XML report not found"
        fi

    - name: Update Jira Test Execution
      if: ${{ always() && steps.xray-upload.outputs.exec_key != '' }}
      shell: pwsh
      env:
        JIRA_CUSTOM_FIELD_OS: ${{ secrets.JIRA_CUSTOM_FIELD_OS }}
        JIRA_CUSTOM_FIELD_OS_VERSION: ${{ secrets.JIRA_CUSTOM_FIELD_OS_VERSION }}
        JIRA_CUSTOM_FIELD_BROWSER: ${{ secrets.JIRA_CUSTOM_FIELD_BROWSER }}
        JIRA_CUSTOM_FIELD_BROWSER_VERSION: ${{ secrets.JIRA_CUSTOM_FIELD_BROWSER_VERSION }}
        JIRA_CUSTOM_FIELD_TEST_SCOPE: ${{ secrets.JIRA_CUSTOM_FIELD_TEST_SCOPE }}
      run: |
        $testResult = "${{ steps.test-result.outputs.result }}"
        Write-Host "Test result from XML report: $testResult"
        
        ./scripts/jira-post-execution.ps1 `
          -ExecKey "${{ steps.xray-upload.outputs.exec_key }}" `
          -DeviceName "${{ env.DEVICE_NAME }}" `
          -TestResult "$testResult" `
          -TestScope "${{ steps.test-pattern.outputs.description }}" `
          -JiraUrl "${{ secrets.JIRA_URL }}" `
          -JiraUser "${{ secrets.JIRA_USER }}" `
          -JiraApiToken "${{ secrets.JIRA_API_TOKEN }}" `
          -GitHubRepository "${{ github.repository }}" `
          -GitHubRunId "${{ github.run_id }}" `
          -GitHubRunNumber "${{ github.run_number }}" `
          -BrowserStackBuildUrl "${{ steps.bs-link.outputs.build_url }}"

    - name: Check test results
      if: always()
      run: |
        if [ "${{ steps.run-tests.outcome }}" == "failure" ]; then
          echo "❌ Des tests ont échoué"
          exit 1
        fi
      shell: bash